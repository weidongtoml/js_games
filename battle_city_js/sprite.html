<!DOCTYPE html>
<html>
  <head>
    <style>
      #tanks, #gems, #landmarks {
        float: left;
      }
    </style>
  </head>
  <body>
    <div id="props">
      <div id="tanks">
        <div id='tank0'></div>
        <div id='tank1'></div>
        <div id='tank2'></div>
        <div id='tank3'></div>
      </div>
      <div id="gems"></div>
      <div id="landmarks"></div>
    </div>
    <script>
      // TANKS
      var DIRECTION_UP = 'up';
      var DIRECTION_LEFT = 'left';
      var DIRECTION_DOWN = 'down';
      var DIRECTION_RIGHT = 'right';

      var TANK_TYPE_SLOW = 'slow';
      var TANK_TYPE_FAST = 'fast';

      var TANK_COLOR_GOLD = 'gold';
      var TANK_COLOR_GREEN = 'green';
      var TANK_COLOR_SILVER = 'silver';
      var TANK_COLOR_RED = 'red';

      // GEMS
      var GEM_HELMET = 'helmet';
      var GEM_CLOCK = 'clock';
      var GEM_SHOVEL = 'shovel';
      var GEM_STAR = 'star';
      var GEM_GRENADE = 'grenade';
      var GEM_TANK = 'tank';
      var GEM_GUN = 'gun';

      var ALL_GEMS = [GEM_HELMET, GEM_CLOCK, GEM_SHOVEL, GEM_STAR,
                      GEM_GRENADE, GEM_TANK, GEM_GUN];

      // LANDMARKS
      var LANDMARK_BRICK = 'brick';
      var LANDMARK_IRON = 'iron';
      var LANDMARK_WATER = 'water';
      var LANDMARK_GRASS = 'grass';
      var LANDMARK_ICE = 'ice';
      var LANDMARK_BASE = 'base';

      var ALL_LANDMARKS = [LANDMARK_BRICK, LANDMARK_IRON, LANDMARK_WATER,
                           LANDMARK_GRASS, LANDMARK_ICE, LANDMARK_BASE];

      // sprite parameters
      var SPRITE_URL = 'NES-BattleCity-Generate.png';
      var SPRITE_WIDTH = 16;
      var SPRITE_HEIGHT = 16;

      // various parameters needed to extract the correct tank image from the sprite.
      var STEP_OFFSET_SIZE = 16;

      var DIRECTION_OFFSET_SIZE = 16 * 2;
      var DIRECTION_TO_H_OFFSET = {};
      DIRECTION_TO_H_OFFSET[DIRECTION_UP] = 0;
      DIRECTION_TO_H_OFFSET[DIRECTION_LEFT] = 1;
      DIRECTION_TO_H_OFFSET[DIRECTION_DOWN] = 2;
      DIRECTION_TO_H_OFFSET[DIRECTION_RIGHT] = 3;

      var TANK_TYPE_OFFSET_SIZE = 16 * 4;
      var TANK_TYPE_TO_OFFSET = {};
      TANK_TYPE_TO_OFFSET[TANK_TYPE_SLOW] = 0;
      TANK_TYPE_TO_OFFSET[TANK_TYPE_FAST] = 1;

      var TANK_COLOR_OFFSET_SIZE = 16 * 8;
      var TANK_COLOR_TO_H_OFFSET = {};
      TANK_COLOR_TO_H_OFFSET[TANK_COLOR_GOLD] = 0;
      TANK_COLOR_TO_H_OFFSET[TANK_COLOR_GREEN] = 0;
      TANK_COLOR_TO_H_OFFSET[TANK_COLOR_SILVER] = 1;
      TANK_COLOR_TO_H_OFFSET[TANK_COLOR_RED] = 1;

      var TANK_COLOR_TO_V_OFFSET = {};
      TANK_COLOR_TO_V_OFFSET[TANK_COLOR_GOLD] = 0;
      TANK_COLOR_TO_V_OFFSET[TANK_COLOR_GREEN] = 1;
      TANK_COLOR_TO_V_OFFSET[TANK_COLOR_SILVER] = 0;
      TANK_COLOR_TO_V_OFFSET[TANK_COLOR_RED] = 1;

      // various parameters for locating the gems in the sprite
      var GEM_INIT_H_OFFSET = 16 * 8 * 2;
      var GEM_INIT_V_OFFSET = 16 * 7;

      var GEM_H_OFFSET_SIZE = 16;
      var GEM_TO_H_OFFSET = {};
      GEM_TO_H_OFFSET[GEM_HELMET] = 0;
      GEM_TO_H_OFFSET[GEM_CLOCK] = 1;
      GEM_TO_H_OFFSET[GEM_SHOVEL] = 2;
      GEM_TO_H_OFFSET[GEM_STAR] = 3;
      GEM_TO_H_OFFSET[GEM_GRENADE] = 4;
      GEM_TO_H_OFFSET[GEM_TANK] = 5;
      GEM_TO_H_OFFSET[GEM_GUN] = 6;

      // various parameters for locating the land marks
      LANDMARK_INIT_H_OFFSET = 16 * 8 * 2;
      LANDMARK_TO_H_OFFSET = {};
      LANDMARK_TO_H_OFFSET[LANDMARK_BRICK] = LANDMARK_INIT_H_OFFSET;
      LANDMARK_TO_H_OFFSET[LANDMARK_IRON] = LANDMARK_INIT_H_OFFSET;
      LANDMARK_TO_H_OFFSET[LANDMARK_WATER] = LANDMARK_INIT_H_OFFSET;
      LANDMARK_TO_H_OFFSET[LANDMARK_GRASS] = LANDMARK_INIT_H_OFFSET + 16;
      LANDMARK_TO_H_OFFSET[LANDMARK_ICE] = LANDMARK_INIT_H_OFFSET + 16 * 2;
      LANDMARK_TO_H_OFFSET[LANDMARK_BASE] = LANDMARK_INIT_H_OFFSET + 16 * 3;

      LANDMARK_TO_V_OFFSET = {};
      LANDMARK_TO_V_OFFSET[LANDMARK_BRICK] = 0;
      LANDMARK_TO_V_OFFSET[LANDMARK_IRON] = 16;
      LANDMARK_TO_V_OFFSET[LANDMARK_WATER] = 16 * 2;
      LANDMARK_TO_V_OFFSET[LANDMARK_GRASS] = 16 * 2;
      LANDMARK_TO_V_OFFSET[LANDMARK_ICE] = 16 * 2;
      LANDMARK_TO_V_OFFSET[LANDMARK_BASE] = 16 * 2;


      var setBasicSpriteStyle = function(domObj) {
        domObj.style.backgroundImage = "url('" + SPRITE_URL + "')";
        domObj.style.width = SPRITE_WIDTH + 'px';
        domObj.style.height = SPRITE_HEIGHT + 'px';
      };

      var setSpriteSrcOffsets = function(domObj, horizontalOffset, verticalOffset) {
        domObj.style.backgroundPosition = (-horizontalOffset) + 'px ' + (-verticalOffset) + 'px ';
      };

      // TODO: refactor this to proper OO style
      var createTank = function(domId, tankType, tankLevel, color, direction) {
        var domObj = document.getElementById(domId, color);

        // TODO: will need to add coordiate, and probably make curStep function of the coordiate
        var state = {
          type: 'tank',
          tankColor: color,
          direction: direction,
          curStep: 0,
          stepSize: 2,
          tankType: tankType,
          tankLevel: tankLevel,
          domObj: domObj
        };

        var init = function() {
          setBasicSpriteStyle(domObj);
          render();
        };

        var render = function() {
          var horizontalOffset = DIRECTION_TO_H_OFFSET[state.direction] * DIRECTION_OFFSET_SIZE +
              TANK_COLOR_TO_H_OFFSET[state.tankColor] * TANK_COLOR_OFFSET_SIZE +
              state.curStep * STEP_OFFSET_SIZE;

          var verticalOffset = TANK_TYPE_TO_OFFSET[state.tankType] * 4 * 16 + state.tankLevel * 16 +
              TANK_COLOR_TO_V_OFFSET[state.tankColor] * TANK_COLOR_OFFSET_SIZE;

//           console.log('horizontalOffset:' + horizontalOffset);
//           console.log('verticalOffset:' + verticalOffset);

          setSpriteSrcOffsets(domObj, horizontalOffset, verticalOffset);

        };

        var update = function() {
          state.curStep = (state.curStep + 1) % state.stepSize;
          render();
        };

        return {
          init: init,
          update: update
        }
      };


      // creates a Gem that can be picked up by the user to do upgrade
      var createGem = function(domId, gemType) {
        var domObj = document.getElementById(domId);
        setBasicSpriteStyle(domObj);

        var init = function() {
          var horizontalOffset = GEM_INIT_H_OFFSET + GEM_TO_H_OFFSET[gemType] * GEM_H_OFFSET_SIZE;
          setSpriteSrcOffsets(domObj, horizontalOffset, GEM_INIT_V_OFFSET);
        };

        return {
          init: init,
          update: function() {}
        };
      };

      // creates a landmark
      var createLandMark = function(domId, landmarkType) {
        var domObj = document.getElementById(domId);
        setBasicSpriteStyle(domObj);

        var init = function() {
          var horizontalOffset = LANDMARK_TO_H_OFFSET[landmarkType];
          var verticalOffset = LANDMARK_TO_V_OFFSET[landmarkType]
          console.log('landmark offsets:' + horizontalOffset + ',' + verticalOffset);
          setSpriteSrcOffsets(domObj, horizontalOffset, verticalOffset);
        };

        return {
          init: init,
          update: function() {}
        };
      };


      var showTanks = function() {

        var tanks = [
          createTank('tank0', TANK_TYPE_SLOW, 0, TANK_COLOR_GOLD, DIRECTION_UP),
          createTank('tank1', TANK_TYPE_SLOW, 1, TANK_COLOR_GREEN, DIRECTION_LEFT),
          createTank('tank2', TANK_TYPE_FAST, 2, TANK_COLOR_SILVER, DIRECTION_DOWN),
          createTank('tank3', TANK_TYPE_FAST, 3, TANK_COLOR_RED, DIRECTION_RIGHT)
        ];

        var i = 0;
        for (i = 0; i < tanks.length; ++i) {
          tanks[i].init();
        }

        setInterval(function(){
          var i = 0;
          for (i = 0; i < tanks.length; ++i) {
            tanks[i].update();
          }
        }, 500);
      };

      var showGems = function() {
        var gemDom = document.getElementById('gems');
        var i;
        var node;
        var nodeId;
        var curGem;
        for (i = 0; i < ALL_GEMS.length; ++i) {
          nodeId = 'gem_' + ALL_GEMS[i];
          node = document.createElement('div');
          node.id = nodeId;
          gemDom.appendChild(node);
          curGem = createGem(nodeId, ALL_GEMS[i]);
          curGem.init();
        }
      };

      var showLandMarks = function() {
        var gemDom = document.getElementById('landmarks');
        var i;
        var node;
        var nodeId;
        var curGem;
        for (i = 0; i < ALL_LANDMARKS.length; ++i) {
          nodeId = 'landmark_' + ALL_LANDMARKS[i];
          node = document.createElement('div');
          node.id = nodeId;
          gemDom.appendChild(node);
          curGem = createLandMark(nodeId, ALL_LANDMARKS[i]);
          curGem.init();
        }
      };

      showTanks();
      showGems();
      showLandMarks();
    </script>
  </body>
</html>
